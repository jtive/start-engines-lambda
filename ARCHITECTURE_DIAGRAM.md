# Architecture Diagrams

## Current Architecture (What You Asked For)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EventBridge (Default Event Bus)               â”‚
â”‚                                                                   â”‚
â”‚  Event: { "source": "custom.app",                                â”‚
â”‚           "detail-type": "Start ECS Task",                       â”‚
â”‚           "detail": { "service": "auth" } }                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lambda: start-engines-lambda                  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Parse EventBridge event                               â”‚   â”‚
â”‚  â”‚ 2. Get service config from config.py                     â”‚   â”‚
â”‚  â”‚ 3. Start ECS task (ecs_handler.py)                       â”‚   â”‚
â”‚  â”‚ 4. Wait for RUNNING state                                â”‚   â”‚
â”‚  â”‚ 5. Extract private IP                                     â”‚   â”‚
â”‚  â”‚ 6. Register with target group (target_group_handler.py)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ECS Cluster      â”‚              â”‚  Target Group      â”‚
â”‚                    â”‚              â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Start Task   â”‚  â”‚              â”‚  â”‚ Register IP  â”‚ â”‚
â”‚  â”‚ Wait RUNNING â”‚  â”‚              â”‚  â”‚ + Port       â”‚ â”‚
â”‚  â”‚ Get IP       â”‚  â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Application Load   â”‚
                                    â”‚ Balancer (ALB)     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Service Configuration Mapping

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         config.py                                   â”‚
â”‚                                                                      â”‚
â”‚  SERVICE_MAPPINGS = {                                               â”‚
â”‚                                                                      â”‚
â”‚    'auth': {                                                        â”‚
â”‚      cluster: 'auth-cluster'                                        â”‚
â”‚      task_definition: 'auth-api-task'                               â”‚
â”‚      target_group: 'arn:...auth-lb/...'                            â”‚
â”‚      port: 8080                                                     â”‚
â”‚    },                                                               â”‚
â”‚                                                                      â”‚
â”‚    'pdf': {                                                         â”‚
â”‚      cluster: 'pdf-cluster'                                         â”‚
â”‚      task_definition: 'pdf-creator-task'                            â”‚
â”‚      target_group: 'arn:...pdf-lb/...'                             â”‚
â”‚      port: 9080                                                     â”‚
â”‚    },                                                               â”‚
â”‚                                                                      â”‚
â”‚    'fa': {                                                          â”‚
â”‚      cluster: 'fa-cluster'                                          â”‚
â”‚      task_definition: 'fa-engine-task'                              â”‚
â”‚      target_group: 'arn:...fa2-tg/...'                             â”‚
â”‚      port: 2531                                                     â”‚
â”‚    },                                                               â”‚
â”‚                                                                      â”‚
â”‚    'users': { ... },                                                â”‚
â”‚    'batch': { ... }                                                 â”‚
â”‚  }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Detailed Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Your App   â”‚
â”‚ (.NET/etc) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ AWS EventBridge PutEvents API
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EventBridge Event                                            â”‚
â”‚ {                                                            â”‚
â”‚   "source": "custom.app",                                    â”‚
â”‚   "detail-type": "Start ECS Task",                           â”‚
â”‚   "detail": { "service": "auth" }                            â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ EventBridge Rule matches pattern
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lambda: lambda_handler()                                     â”‚
â”‚                                                              â”‚
â”‚ Step 1: Parse event                                          â”‚
â”‚   â”œâ”€ Get service name from event.detail.service             â”‚
â”‚   â””â”€ Validate event structure                               â”‚
â”‚                                                              â”‚
â”‚ Step 2: Get configuration (config.py)                        â”‚
â”‚   â”œâ”€ Look up service in SERVICE_MAPPINGS                    â”‚
â”‚   â”œâ”€ Get cluster name, task def, target group ARN          â”‚
â”‚   â”œâ”€ Get subnets, security groups                           â”‚
â”‚   â””â”€ Apply any overrides from event                         â”‚
â”‚                                                              â”‚
â”‚ Step 3: Start ECS Task (ecs_handler.py)                     â”‚
â”‚   â”œâ”€ Call ECS RunTask API                                   â”‚
â”‚   â”œâ”€ Parameters:                                             â”‚
â”‚   â”‚   â€¢ cluster                                              â”‚
â”‚   â”‚   â€¢ taskDefinition                                       â”‚
â”‚   â”‚   â€¢ launchType: FARGATE                                  â”‚
â”‚   â”‚   â€¢ networkConfiguration: subnets, SGs                   â”‚
â”‚   â””â”€ Get task ARN                                            â”‚
â”‚                                                              â”‚
â”‚ Step 4: Wait for RUNNING (ecs_handler.py)                   â”‚
â”‚   â”œâ”€ Poll ECS DescribeTasks every 5 seconds                 â”‚
â”‚   â”œâ”€ Check lastStatus == 'RUNNING'                          â”‚
â”‚   â”œâ”€ Extract private IP from ENI                            â”‚
â”‚   â””â”€ Timeout after 5 minutes                                â”‚
â”‚                                                              â”‚
â”‚ Step 5: Register Target (target_group_handler.py)           â”‚
â”‚   â”œâ”€ Call ELB RegisterTargets API                           â”‚
â”‚   â”œâ”€ Parameters:                                             â”‚
â”‚   â”‚   â€¢ TargetGroupArn                                       â”‚
â”‚   â”‚   â€¢ Targets: [{ Id: privateIP, Port: port }]           â”‚
â”‚   â””â”€ Optionally wait for healthy status                     â”‚
â”‚                                                              â”‚
â”‚ Step 6: Return Success                                       â”‚
â”‚   â””â”€ Return: {                                               â”‚
â”‚         statusCode: 200,                                     â”‚
â”‚         body: {                                              â”‚
â”‚           taskArn, taskId, privateIp, port,                 â”‚
â”‚           targetGroupArn, healthStatus                       â”‚
â”‚         }                                                    â”‚
â”‚       }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Result                                                       â”‚
â”‚                                                              â”‚
â”‚ âœ… ECS Task running at 10.0.1.100:8080                      â”‚
â”‚ âœ… Registered with auth-lb target group                     â”‚
â”‚ âœ… Health checks starting                                    â”‚
â”‚ âœ… Ready to receive traffic from ALB                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Network Flow (awsvpc mode)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VPC (us-east-2)                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Public Subnet                                           â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚  â”‚ Application Load Balancer â”‚                          â”‚   â”‚
â”‚  â”‚  â”‚ (ALB)                     â”‚                          â”‚   â”‚
â”‚  â”‚  â”‚                           â”‚                          â”‚   â”‚
â”‚  â”‚  â”‚ Listener: HTTPS:443       â”‚                          â”‚   â”‚
â”‚  â”‚  â”‚ Rules:                    â”‚                          â”‚   â”‚
â”‚  â”‚  â”‚  /api/auth/* â†’ auth-tg   â”‚                          â”‚   â”‚
â”‚  â”‚  â”‚  /api/pdf/*  â†’ pdf-tg    â”‚                          â”‚   â”‚
â”‚  â”‚  â”‚  /api/fa/*   â†’ fa-tg     â”‚                          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â”‚                                               â”‚
â”‚                â”‚ HTTP to target IP:port                        â”‚
â”‚                â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Private Subnet                                         â”‚   â”‚
â”‚  â”‚             â”‚                                           â”‚   â”‚
â”‚  â”‚             â–¼                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚   â”‚
â”‚  â”‚  â”‚ ECS Task (Fargate)  â”‚                               â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚                               â”‚   â”‚
â”‚  â”‚  â”‚ ENI: 10.0.1.100     â”‚â—„â”€â”€â”€â”€â”€ Lambda registers this  â”‚   â”‚
â”‚  â”‚  â”‚ Port: 8080          â”‚       IP with target group    â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚                               â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                               â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ AuthAPI         â”‚ â”‚                               â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ Container       â”‚ â”‚                               â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ Listening:8080  â”‚ â”‚                               â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cost Optimization Architecture (Recommended)

### Before (Current - 5 ALBs)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React App    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚
       â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ... 3 more ALBs
â”‚ ALB 1    â”‚    â”‚ ALB 2    â”‚
â”‚ $16/mo   â”‚    â”‚ $16/mo   â”‚    Total: ~$200/month
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â–¼               â–¼
   Auth           PDF
   ECS            ECS
```

### After (Optimized - 1 ALB)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React App    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Single ALB ($20/month)           â”‚
â”‚                                   â”‚
â”‚ Path-based routing:               â”‚
â”‚  /api/auth/*  â†’ auth-tg          â”‚
â”‚  /api/pdf/*   â†’ pdf-tg           â”‚
â”‚  /api/fa/*    â†’ fa-tg            â”‚
â”‚  /api/users/* â†’ users-tg         â”‚
â”‚  /api/batch/* â†’ batch-tg         â”‚
â””â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚   â”‚   â”‚   â”‚   â”‚
   â–¼   â–¼   â–¼   â–¼   â–¼
  Auth PDF FA Users Batch
  ECS  ECS ECS ECS   ECS

ğŸ’° SAVINGS: $180/month = $2,160/year
```

---

## IAM Permissions Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lambda Execution Role                                       â”‚
â”‚                                                             â”‚
â”‚ Permissions:                                                â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ECS Permissions                                   â”‚     â”‚
â”‚  â”‚ â€¢ ecs:RunTask                                     â”‚     â”‚
â”‚  â”‚ â€¢ ecs:DescribeTasks                               â”‚     â”‚
â”‚  â”‚ â€¢ ecs:DescribeTaskDefinition                      â”‚     â”‚
â”‚  â”‚ â€¢ ecs:StopTask                                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ELB Permissions                                   â”‚     â”‚
â”‚  â”‚ â€¢ elasticloadbalancing:RegisterTargets            â”‚     â”‚
â”‚  â”‚ â€¢ elasticloadbalancing:DeregisterTargets          â”‚     â”‚
â”‚  â”‚ â€¢ elasticloadbalancing:DescribeTargetHealth       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ EC2 Permissions                                   â”‚     â”‚
â”‚  â”‚ â€¢ ec2:DescribeNetworkInterfaces                   â”‚     â”‚
â”‚  â”‚ â€¢ ec2:DescribeSubnets                              â”‚     â”‚
â”‚  â”‚ â€¢ ec2:DescribeSecurityGroups                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ IAM Permissions                                   â”‚     â”‚
â”‚  â”‚ â€¢ iam:PassRole (for ECS task execution role)     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CloudWatch Logs                                   â”‚     â”‚
â”‚  â”‚ â€¢ logs:CreateLogGroup                             â”‚     â”‚
â”‚  â”‚ â€¢ logs:CreateLogStream                            â”‚     â”‚
â”‚  â”‚ â€¢ logs:PutLogEvents                               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure and Dependencies

```
start-engines-lambda/
â”‚
â”œâ”€â”€ lambda_function.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   (Main handler)                â”‚
â”‚                                 â”‚  imports
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ lambda_handler()        â”‚â—„â”€â”¤
â”‚   â”‚  â”œâ”€ Parse event         â”‚  â”‚
â”‚   â”‚  â”œâ”€ Get config          â”‚â”€â”€â”¼â”€â–º config.py
â”‚   â”‚  â”œâ”€ Start ECS task      â”‚â”€â”€â”¼â”€â–º ecs_handler.py
â”‚   â”‚  â””â”€ Register target     â”‚â”€â”€â”¼â”€â–º target_group_handler.py
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”œâ”€â”€ config.py                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ SERVICE_MAPPINGS        â”‚â—„â”€â”¤
â”‚   â”‚ get_service_config()    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”œâ”€â”€ ecs_handler.py                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ECSHandler class        â”‚â—„â”€â”¤
â”‚   â”‚  â”œâ”€ start_task()        â”‚  â”‚
â”‚   â”‚  â”œâ”€ _wait_for_running() â”‚  â”‚
â”‚   â”‚  â””â”€ _extract_ip()       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”œâ”€â”€ target_group_handler.py       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ TargetGroupHandler      â”‚â—„â”€â”˜
â”‚   â”‚  â”œâ”€ register_target()   â”‚
â”‚   â”‚  â”œâ”€ get_target_health() â”‚
â”‚   â”‚  â””â”€ _wait_for_healthy() â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”œâ”€â”€ requirements.txt
â”‚   â€¢ boto3>=1.28.0
â”‚   â€¢ pytest (for testing)
â”‚
â”œâ”€â”€ template.yaml
â”‚   (SAM deployment template)
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ test_lambda_function.py
    â””â”€â”€ test_config.py
```

---

## Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Developer Workstation                                        â”‚
â”‚                                                              â”‚
â”‚  1. sam build â”€â”€â”€â”€â”€â”€â–º Package code + dependencies           â”‚
â”‚                                                              â”‚
â”‚  2. sam deploy â”€â”€â”€â”€â”€â–º Upload to S3                          â”‚
â”‚         â”‚                                                    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Create CloudFormation Stack           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AWS CloudFormation                                           â”‚
â”‚                                                              â”‚
â”‚  Creates:                                                    â”‚
â”‚   â”œâ”€ Lambda Function (start-engines-lambda-dev)            â”‚
â”‚   â”œâ”€ IAM Execution Role (with policies)                     â”‚
â”‚   â”œâ”€ CloudWatch Log Group                                   â”‚
â”‚   â””â”€ EventBridge Rule (triggers Lambda)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Deployed Resources (AWS Region: us-east-2)                  â”‚
â”‚                                                              â”‚
â”‚  Lambda Function: start-engines-lambda-dev                  â”‚
â”‚  EventBridge Rule: Start ECS Task event pattern            â”‚
â”‚  IAM Role: start-engines-lambda-role-dev                    â”‚
â”‚  Log Group: /aws/lambda/start-engines-lambda-dev            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Integration Patterns

### Pattern 1: Direct EventBridge (Recommended)

```
Your .NET App â†’ EventBridge PutEvents â†’ Lambda â†’ ECS
```

### Pattern 2: API Gateway

```
Your .NET App â†’ API Gateway â†’ Lambda â†’ ECS
```

### Pattern 3: Step Functions (For Complex Workflows)

```
Trigger â†’ Step Functions â†’ Lambda â†’ ECS
                         â†“
                    (orchestration)
```

### Pattern 4: Scheduled (Cron)

```
CloudWatch Events (cron) â†’ Lambda â†’ ECS
(e.g., start tasks every morning)
```

